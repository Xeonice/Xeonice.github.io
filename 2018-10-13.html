<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">






  
  
    
      
    
    
      
    
  <script src="https://cdn.staticfile.org/pace/1.0.2/pace.min.js"></script>
  <link href="https://cdn.staticfile.org/pace/1.0.2/themes/black/pace-theme-corner-indicator.min.css" rel="stylesheet">




  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="1AN0l5FFDH_bGnLzRh2TsBOsw54Rl3zuA7kUviXkk6o" />














  
  
    
  
  <link href="https://cdn.staticfile.org/fancybox/3.3.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







  

<link href="https://cdn.staticfile.org/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.4.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="create-react-app 是我们最经常使用的脚手架工具，它的功能如何被实现？">
<meta name="keywords" content="JavaScript, React-UI">
<meta property="og:type" content="article">
<meta property="og:title" content="create-react-app 源代码分析">
<meta property="og:url" content="https://www.douglasdong.site/2018-10-13.html">
<meta property="og:site_name" content="Helve&#39;s Blog">
<meta property="og:description" content="create-react-app 是我们最经常使用的脚手架工具，它的功能如何被实现？">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-12-22T04:41:20.263Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="create-react-app 源代码分析">
<meta name="twitter:description" content="create-react-app 是我们最经常使用的脚手架工具，它的功能如何被实现？">



  <link rel="alternate" href="/atom.xml" title="Helve's Blog" type="application/atom+xml" />




  <link rel="canonical" href="https://www.douglasdong.site/2018-10-13.html"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>create-react-app 源代码分析 | Helve's Blog</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?381279f888e646c9a4386fba79ee174b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Helve's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">前端学习杂录</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签<span class="badge">7</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类<span class="badge">9</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档<span class="badge">28</span></a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.douglasdong.site/2018-10-13.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Helvetica.D">
      <meta itemprop="description" content="P5天下第一！！">
      <meta itemprop="image" content="/images/avatar.PNG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Helve's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">create-react-app 源代码分析
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-10-13 18:02:56" itemprop="dateCreated datePublished" datetime="2018-10-13T18:02:56+08:00">2018-10-13</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/React-源码分析/" itemprop="url" rel="index"><span itemprop="name">React 源码分析</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018-10-13.html#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count gitment-comments-count" data-xid="/2018-10-13.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">27k字</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">25 分钟</span>
              
            </div>
          

          
              <div class="post-description"><center>create-react-app 是我们最经常使用的脚手架工具，它的功能如何被实现？</center></div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <script src="/assets/js/APlayer.min.js"> </script><h1 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h1><p>分析一个项目的代码，首先从它的入口文件开始</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"private"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"workspaces"</span>: [</span><br><span class="line">    <span class="string">"packages/*"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"cd packages/react-scripts &amp;&amp; node scripts/build.js"</span>,</span><br><span class="line">    <span class="attr">"changelog"</span>: <span class="string">"lerna-changelog"</span>,</span><br><span class="line">    <span class="attr">"create-react-app"</span>: <span class="string">"node tasks/cra.js"</span>,</span><br><span class="line">    <span class="attr">"e2e"</span>: <span class="string">"tasks/e2e-simple.sh"</span>,</span><br><span class="line">    <span class="attr">"e2e:docker"</span>: <span class="string">"tasks/local-test.sh"</span>,</span><br><span class="line">    <span class="attr">"postinstall"</span>: <span class="string">"cd packages/react-error-overlay/ &amp;&amp; yarn build:prod"</span>,</span><br><span class="line">    <span class="attr">"publish"</span>: <span class="string">"tasks/publish.sh"</span>,</span><br><span class="line">    <span class="attr">"start"</span>: <span class="string">"cd packages/react-scripts &amp;&amp; node scripts/start.js"</span>,</span><br><span class="line">    <span class="attr">"screencast"</span>: <span class="string">"svg-term --cast hItN7sl5yfCPTHxvFg5glhhfp --out screencast.svg --window"</span>,</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"cd packages/react-scripts &amp;&amp; node scripts/test.js --env=jsdom"</span>,</span><br><span class="line">    <span class="attr">"format"</span>: <span class="string">"prettier --trailing-comma es5 --single-quote --write 'packages/*/*.js' 'packages/*/!(node_modules)/**/*.js'"</span>,</span><br><span class="line">    <span class="attr">"precommit"</span>: <span class="string">"lint-staged"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"eslint"</span>: <span class="string">"^4.4.1"</span>,</span><br><span class="line">    <span class="attr">"husky"</span>: <span class="string">"^0.13.2"</span>,</span><br><span class="line">    <span class="attr">"lerna"</span>: <span class="string">"2.6.0"</span>,</span><br><span class="line">    <span class="attr">"lerna-changelog"</span>: <span class="string">"^0.6.0"</span>,</span><br><span class="line">    <span class="attr">"lint-staged"</span>: <span class="string">"^3.3.1"</span>,</span><br><span class="line">    <span class="attr">"prettier"</span>: <span class="string">"1.6.1"</span>,</span><br><span class="line">    <span class="attr">"svg-term-cli"</span>: <span class="string">"^2.0.3"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"lint-staged"</span>: &#123;</span><br><span class="line">    <span class="attr">"*.js"</span>: [</span><br><span class="line">      <span class="string">"prettier --trailing-comma es5 --single-quote --write"</span>,</span><br><span class="line">      <span class="string">"git add"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"yarn.lock"</span>: [</span><br><span class="line">      <span class="string">"git rm --cached"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="devDependencies"><a href="#devDependencies" class="headerlink" title="devDependencies"></a>devDependencies</h2><p>从整个入口文件中，我们可以看到，它所采用的开发依赖主要为</p>
<ul>
<li><code>eslint</code> – 用于规范代码的工具</li>
<li><code>husky</code> – <code>git commit</code> 的钩子函数</li>
<li><code>lerna</code> – 用于管理多 <code>package</code> 项目，具体使用可参见<a href="https://juejin.im/post/5a989fb451882555731b88c2" target="_blank" rel="noopener">lerna管理前端packages的最佳实践</a></li>
<li><code>lerna-changelog</code> – 同上</li>
<li><code>lint-staged</code> – 指定 <code>commit</code> 钩子函数应用于现有提交代码</li>
<li><code>prettier</code> – 代码格式化工具，它可以支持 <code>JS/JSX/TS/Flow/JSON/CSS/LESS</code> 等文件格式</li>
<li><code>svg-term-cli</code> –输出 <code>ASCII</code> 动画？</li>
</ul>
<p>接下来我们来直接分析它的主目录 – <code>packages</code></p>
<h1 id="packages"><a href="#packages" class="headerlink" title="packages"></a>packages</h1><p><code>packages</code> 文件夹下有 6 个进行过规范命名的子文件夹：</p>
<ul>
<li>babel-preset-react-app</li>
<li>create-react-app</li>
<li>eslint-config-react-app</li>
<li>react-dev-utils</li>
<li>react-error-overlay</li>
<li>react-scripts</li>
</ul>
<h2 id="create-react-app"><a href="#create-react-app" class="headerlink" title="create-react-app"></a>create-react-app</h2><p><code>create-react-app</code> 由入口文件 <code>index.js</code> 和 <code>create-react-app.js</code> 这两个文件组成</p>
<h3 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h3><p><code>index.js</code> 省略上面一大段的注释后还是非常简短的，下面我们通过边调试边分析的方式来分析这整段代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>); <span class="comment">// 一个将命令行中输出的命令变色的库</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> currentNodeVersion = process.versions.node; <span class="comment">// 获取当前 node 版本号</span></span><br><span class="line"><span class="keyword">var</span> semver = currentNodeVersion.split(<span class="string">'.'</span>); </span><br><span class="line"><span class="keyword">var</span> major = semver[<span class="number">0</span>]; <span class="comment">// 取出第一位版本号，如 10.10.0 只取 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Node 版本小于 4 直接跳出</span></span><br><span class="line"><span class="keyword">if</span> (major &lt; <span class="number">4</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(</span><br><span class="line">    chalk.red(</span><br><span class="line">      <span class="string">'You are running Node '</span> +</span><br><span class="line">        currentNodeVersion +</span><br><span class="line">        <span class="string">'.\n'</span> +</span><br><span class="line">        <span class="string">'Create React App requires Node 4 or higher. \n'</span> +</span><br><span class="line">        <span class="string">'Please update your version of Node.'</span></span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./createReactApp'</span>);</span><br></pre></td></tr></table></figure>
<p>上述的代码涉及到两个 <code>Node</code> 提供的 API，<a href="http://nodejs.cn/api/process.html#process_process_versions" target="_blank" rel="noopener">process.versions</a>、<a href="http://nodejs.cn/api/process.html#process_process_exit_code" target="_blank" rel="noopener">process.exit</a>，简要的 API 说明如下：</p>
<ul>
<li><code>process.versions</code> – 返回一个对象，其中包含各种 <code>Node.js</code> 和其依赖的版本信息</li>
<li><code>process.exit</code> – 结束 <code>Node</code> 进程，<code>1</code> 是状态码，表示有异常没有处理</li>
</ul>
<p><code>Node.js</code> 用于错误处理的状态码可以参看这篇文档<a href="http://nodejs.cn/api/process.html#process_process_exit_code" target="_blank" rel="noopener">Exit Codes</a></p>
<h2 id="create-react-app-1"><a href="#create-react-app-1" class="headerlink" title="create-react-app"></a>create-react-app</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> validateProjectName = <span class="built_in">require</span>(<span class="string">'validate-npm-package-name'</span>);</span><br><span class="line"><span class="keyword">const</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>);</span><br><span class="line"><span class="keyword">const</span> commander = <span class="built_in">require</span>(<span class="string">'commander'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs-extra'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> execSync = <span class="built_in">require</span>(<span class="string">'child_process'</span>).execSync;</span><br><span class="line"><span class="keyword">const</span> spawn = <span class="built_in">require</span>(<span class="string">'cross-spawn'</span>);</span><br><span class="line"><span class="keyword">const</span> semver = <span class="built_in">require</span>(<span class="string">'semver'</span>);</span><br><span class="line"><span class="keyword">const</span> dns = <span class="built_in">require</span>(<span class="string">'dns'</span>);</span><br><span class="line"><span class="keyword">const</span> tmp = <span class="built_in">require</span>(<span class="string">'tmp'</span>);</span><br><span class="line"><span class="keyword">const</span> unpack = <span class="built_in">require</span>(<span class="string">'tar-pack'</span>).unpack;</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">const</span> hyperquest = <span class="built_in">require</span>(<span class="string">'hyperquest'</span>);</span><br><span class="line"><span class="keyword">const</span> envinfo = <span class="built_in">require</span>(<span class="string">'envinfo'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> packageJson = <span class="built_in">require</span>(<span class="string">'./package.json'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> projectName; <span class="comment">// 定义了一个用来存储项目名称的变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> program = <span class="keyword">new</span> commander.Command(packageJson.name) <span class="comment">// 构建 node 命令行工具的库</span></span><br><span class="line">  .version(packageJson.version) <span class="comment">// 输入 create-react-app -v 时读取所需的版本信息</span></span><br><span class="line">  .arguments(<span class="string">'&lt;project-directory&gt;'</span>) <span class="comment">// 传入 create-react-app &lt;my-project&gt; 中尖括号中的参数</span></span><br><span class="line">  .usage(<span class="string">`<span class="subst">$&#123;chalk.green(<span class="string">'&lt;project-directory&gt;'</span>)&#125;</span> [options]`</span>) <span class="comment">// 输入 create-react-app 时第一行打印的信息</span></span><br><span class="line">  .action(<span class="function"><span class="params">name</span> =&gt;</span> &#123; <span class="comment">// 初始化项目名称，就是之前 argument 中的 &lt;project-directory&gt;</span></span><br><span class="line">    projectName = name;</span><br><span class="line">  &#125;)</span><br><span class="line">  .option(<span class="string">'--verbose'</span>, <span class="string">'print additional logs'</span>) <span class="comment">// 配置 create-react-app -[option] 的选项，类似 --help、-V</span></span><br><span class="line">  .option(<span class="string">'--info'</span>, <span class="string">'print environment debug info'</span>) <span class="comment">// 打印本地相关开发环境</span></span><br><span class="line">  .option( <span class="comment">// 使用特殊的 react-scripts</span></span><br><span class="line">    <span class="string">'--scripts-version &lt;alternative-package&gt;'</span>,</span><br><span class="line">    <span class="string">'use a non-standard version of react-scripts'</span></span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// 默认使用 yarn，指定此参数使用 npm</span></span><br><span class="line">  .option(<span class="string">'--use-npm'</span>)</span><br><span class="line">  .allowUnknownOption() <span class="comment">// 允许无效的 option 键入</span></span><br><span class="line">  .on(<span class="string">'--help'</span>, () =&gt; &#123; <span class="comment">// --help 时打印的信息，这里省去</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 最后一行接受命令行参数</span></span><br><span class="line">  .parse(process.argv);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是一个开发者内部使用的方法，可以自定义输出的模版文件夹</span></span><br><span class="line"><span class="keyword">const</span> hiddenProgram = <span class="keyword">new</span> commander.Command()</span><br><span class="line">  .option(</span><br><span class="line">    <span class="string">'--internal-testing-template &lt;path-to-template&gt;'</span>,</span><br><span class="line">    <span class="string">'(internal usage only, DO NOT RELY ON THIS) '</span> +</span><br><span class="line">      <span class="string">'use a non-standard application template'</span></span><br><span class="line">  )</span><br><span class="line">  .parse(process.argv);</span><br><span class="line"><span class="comment">// 如果执行时没有传入指定目录</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> projectName === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果带了 --info 参数就执行下列代码，不会跳出报错</span></span><br><span class="line">  <span class="keyword">if</span> (program.info) &#123;</span><br><span class="line">    <span class="comment">// 打印当前环境信息和 ‘react’、‘react-dom’、‘react-script’ 三个包的信息</span></span><br><span class="line">    envinfo.print(&#123;</span><br><span class="line">      packages: [<span class="string">'react'</span>, <span class="string">'react-dom'</span>, <span class="string">'react-scripts'</span>],</span><br><span class="line">      noNativeIDE: <span class="literal">true</span>,</span><br><span class="line">      duplicates: <span class="literal">true</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    process.exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 否则就抛出错误和使用方法</span></span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">'Please specify the project directory:'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(</span><br><span class="line">    <span class="string">`  <span class="subst">$&#123;chalk.cyan(program.name())&#125;</span> <span class="subst">$&#123;chalk.green(<span class="string">'&lt;project-directory&gt;'</span>)&#125;</span>`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">console</span>.log();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'For example:'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`  <span class="subst">$&#123;chalk.cyan(program.name())&#125;</span> <span class="subst">$&#123;chalk.green(<span class="string">'my-react-app'</span>)&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log();</span><br><span class="line">  <span class="built_in">console</span>.log(</span><br><span class="line">    <span class="string">`Run <span class="subst">$&#123;chalk.cyan(<span class="string">`<span class="subst">$&#123;program.name()&#125;</span> --help`</span>)&#125;</span> to see all options.`</span></span><br><span class="line">  );</span><br><span class="line">  process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 符合条件时调用 createApp 函数</span></span><br><span class="line"><span class="comment">// 其中有五个参数，分别是 projectName，program.verbose，program.scriptsVersion，program.useNpm，hiddenProgram.internalTestingTemplate</span></span><br><span class="line"><span class="comment">// projectName -- 执行时传入的项目名称</span></span><br><span class="line"><span class="comment">// program.verbose -- 在 yarn 和 npm 安装的时候打印本地信息</span></span><br><span class="line"><span class="comment">// program.scriptsVersion -- 指定 react-scripts 版本</span></span><br><span class="line"><span class="comment">// program.useNpm -- 使用 npm 还是 yarn</span></span><br><span class="line"><span class="comment">// hiddenProgram.internalTestingTemplate -- 之前提到过的，指定初始化的模版</span></span><br><span class="line">createApp(</span><br><span class="line">  projectName,</span><br><span class="line">  program.verbose,</span><br><span class="line">  program.scriptsVersion,</span><br><span class="line">  program.useNpm,</span><br><span class="line">  hiddenProgram.internalTestingTemplate</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params">name, verbose, version, useNpm, template</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = path.resolve(name); <span class="comment">// 获取传入目录的绝对路径</span></span><br><span class="line">  <span class="keyword">const</span> appName = path.basename(root); <span class="comment">// 返回绝对路径的最后一部分</span></span><br><span class="line"></span><br><span class="line">  checkAppName(appName); <span class="comment">// 判断文件名是否合法</span></span><br><span class="line">  fs.ensureDirSync(name); <span class="comment">// 判断当前目录下是否有这个文件夹，没有就创建（PS：这里的 fs 调用的是 fs-extra 下的内容）https://juejin.im/post/5b52fd21e51d4519234468f1</span></span><br><span class="line">  <span class="comment">// 判断文件夹下是否有可能会造成冲突的文件 / 文件夹名称是否被占用</span></span><br><span class="line">  <span class="keyword">if</span> (!isSafeToCreateProjectIn(root, name)) &#123;</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 提示已成功创建</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Creating a new React app in <span class="subst">$&#123;chalk.green(root)&#125;</span>.`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log();</span><br><span class="line">  <span class="comment">// 初始化 package.json 基本内容</span></span><br><span class="line">  <span class="keyword">const</span> packageJson = &#123;</span><br><span class="line">    name: appName,</span><br><span class="line">    version: <span class="string">'0.1.0'</span>,</span><br><span class="line">    private: <span class="literal">true</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 向创建文件夹内写入 package.json 文件</span></span><br><span class="line">  fs.writeFileSync(</span><br><span class="line">    path.join(root, <span class="string">'package.json'</span>),</span><br><span class="line">    <span class="built_in">JSON</span>.stringify(packageJson, <span class="literal">null</span>, <span class="number">2</span>)</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 定义常量 useYarn，如果指定使用 npm 则定义为 false</span></span><br><span class="line">  <span class="comment">// 否则调用 shouldUseYarn 查询本机是否安装 yarn</span></span><br><span class="line">  <span class="keyword">const</span> useYarn = useNpm ? <span class="literal">false</span> : shouldUseYarn();</span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="keyword">const</span> originalDirectory = process.cwd();</span><br><span class="line">  <span class="comment">// 变更 Node.js 进程的当前工作目录</span></span><br><span class="line">  process.chdir(root);</span><br><span class="line">  <span class="comment">// checkThatNpmCanReadCwd 这个函数的作用是检查进程目录是否是我们创建的目录</span></span><br><span class="line">  <span class="keyword">if</span> (!useYarn &amp;&amp; !checkThatNpmCanReadCwd()) &#123;</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 比较 node 版本，小于 6 的时候发出警告，并制定 react-scripts 版本为支持 6 以下的 0.9</span></span><br><span class="line">  <span class="keyword">if</span> (!semver.satisfies(process.version, <span class="string">'&gt;=6.0.0'</span>)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(</span><br><span class="line">      chalk.yellow(</span><br><span class="line">        <span class="string">`You are using Node <span class="subst">$&#123;process.version&#125;</span> so the project will be bootstrapped with an old unsupported version of tools.\n\n`</span> +</span><br><span class="line">          <span class="string">`Please update to Node 6 or higher for a better, fully supported experience.\n`</span></span><br><span class="line">      )</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// Fall back to latest supported react-scripts on Node 4</span></span><br><span class="line">    version = <span class="string">'react-scripts@0.9.x'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果未使用 yarn，而且 npm 版本在 3 以下的时候进行提示</span></span><br><span class="line">  <span class="comment">// 如果 npm 版本在 3 以上，自动将 react-scripts 切到 0.9</span></span><br><span class="line">  <span class="keyword">if</span> (!useYarn) &#123;</span><br><span class="line">    <span class="keyword">const</span> npmInfo = checkNpmVersion();</span><br><span class="line">    <span class="keyword">if</span> (!npmInfo.hasMinNpm) &#123;</span><br><span class="line">      <span class="keyword">if</span> (npmInfo.npmVersion) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">          chalk.yellow(</span><br><span class="line">            <span class="string">`You are using npm <span class="subst">$&#123;npmInfo.npmVersion&#125;</span> so the project will be boostrapped with an old unsupported version of tools.\n\n`</span> +</span><br><span class="line">              <span class="string">`Please update to npm 3 or higher for a better, fully supported experience.\n`</span></span><br><span class="line">          )</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Fall back to latest supported react-scripts for npm 3</span></span><br><span class="line">      version = <span class="string">'react-scripts@0.9.x'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 传入这些参数执行 run 函数</span></span><br><span class="line">  run(root, appName, version, verbose, originalDirectory, template, useYarn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来在开始下一个核心函数之前，我们先来了解一下 <code>createApp</code> 所需要调用的依赖</p>
<p>外部依赖：</p>
<ul>
<li><code>fs-extra</code>：外部依赖，<code>Node</code> 自带文件模块的外部扩展模块</li>
<li><code>semver</code>：用于比较 npm 版本</li>
</ul>
<p>函数依赖：</p>
<ul>
<li><code>checkAppName</code> – 用于检测文件名是否合法</li>
<li><code>isSafeToCreateProjectIn</code> – 判断文件夹下是否有可能会造成冲突的文件 / 文件夹名称是否被占用</li>
<li><code>shouldUseYarn</code> – 检测 <code>yarn</code> 是否已经安装</li>
<li><code>CheckThatNpmCanReadCwd</code> – 检测 <code>npm</code> 是否在正确的目录下执行</li>
<li><code>checkNpmVersion</code> – 检测 <code>npm</code> 是否在本机安装</li>
</ul>
<h3 id="checkAppName"><a href="#checkAppName" class="headerlink" title="checkAppName()"></a>checkAppName()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkAppName</span>(<span class="params">appName</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 使用 validateProjectName 检查包名是否返回结果，这个 validateProjectName 是外部依赖的引用</span></span><br><span class="line">  <span class="keyword">const</span> validationResult = validateProjectName(appName);</span><br><span class="line">  <span class="comment">// 如果对象中有错误则抛出并报错（不符合 npm 命名规范）</span></span><br><span class="line">  <span class="keyword">if</span> (!validationResult.validForNewPackages) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(</span><br><span class="line">      <span class="string">`Could not create a project called <span class="subst">$&#123;chalk.red(</span></span></span><br><span class="line"><span class="string"><span class="subst">        <span class="string">`"<span class="subst">$&#123;appName&#125;</span>"`</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      )&#125;</span> because of npm naming restrictions:`</span></span><br><span class="line">    );</span><br><span class="line">    printValidationResults(validationResult.errors);</span><br><span class="line">    printValidationResults(validationResult.warnings);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> there should be a single place that holds the dependencies</span></span><br><span class="line">  <span class="keyword">const</span> dependencies = [<span class="string">'react'</span>, <span class="string">'react-dom'</span>, <span class="string">'react-scripts'</span>].sort();</span><br><span class="line">  <span class="comment">// 和依赖重名时报错并跳出</span></span><br><span class="line">  <span class="keyword">if</span> (dependencies.indexOf(appName) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(</span><br><span class="line">      chalk.red(</span><br><span class="line">        <span class="string">`We cannot create a project called <span class="subst">$&#123;chalk.green(</span></span></span><br><span class="line"><span class="string"><span class="subst">          appName</span></span></span><br><span class="line"><span class="string"><span class="subst">        )&#125;</span> because a dependency with the same name exists.\n`</span> +</span><br><span class="line">          <span class="string">`Due to the way npm works, the following names are not allowed:\n\n`</span></span><br><span class="line">      ) +</span><br><span class="line">        chalk.cyan(dependencies.map(<span class="function"><span class="params">depName</span> =&gt;</span> <span class="string">`  <span class="subst">$&#123;depName&#125;</span>`</span>).join(<span class="string">'\n'</span>)) +</span><br><span class="line">        chalk.red(<span class="string">'\n\nPlease choose a different project name.'</span>)</span><br><span class="line">    );</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里主要就是用了一个外部依赖来校验文件名是否符合 <code>npm</code> 包文件名的规范，并判断了一下和依赖重名时的情况</p>
<p>外部依赖：</p>
<ul>
<li><code>validate-npm-package-name</code> – 检查包名是否合法</li>
</ul>
<h3 id="isSafeToCreateProjectIn"><a href="#isSafeToCreateProjectIn" class="headerlink" title="isSafeToCreateProjectIn"></a>isSafeToCreateProjectIn</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isSafeToCreateProjectIn</span>(<span class="params">root, name</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果是这些文件就不算冲突</span></span><br><span class="line">  <span class="keyword">const</span> validFiles = [</span><br><span class="line">    <span class="string">'.DS_Store'</span>,</span><br><span class="line">    <span class="string">'Thumbs.db'</span>,</span><br><span class="line">    <span class="string">'.git'</span>,</span><br><span class="line">    <span class="string">'.gitignore'</span>,</span><br><span class="line">    <span class="string">'.idea'</span>,</span><br><span class="line">    <span class="string">'README.md'</span>,</span><br><span class="line">    <span class="string">'LICENSE'</span>,</span><br><span class="line">    <span class="string">'web.iml'</span>,</span><br><span class="line">    <span class="string">'.hg'</span>,</span><br><span class="line">    <span class="string">'.hgignore'</span>,</span><br><span class="line">    <span class="string">'.hgcheck'</span>,</span><br><span class="line">    <span class="string">'.npmignore'</span>,</span><br><span class="line">    <span class="string">'mkdocs.yml'</span>,</span><br><span class="line">    <span class="string">'docs'</span>,</span><br><span class="line">    <span class="string">'.travis.yml'</span>,</span><br><span class="line">    <span class="string">'.gitlab-ci.yml'</span>,</span><br><span class="line">    <span class="string">'.gitattributes'</span>,</span><br><span class="line">  ];</span><br><span class="line">  <span class="built_in">console</span>.log();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 在创建好的项目文件夹下搜索，除上述文件外，不包含其他文件就返回 true</span></span><br><span class="line">  <span class="keyword">const</span> conflicts = fs</span><br><span class="line">    .readdirSync(root)</span><br><span class="line">    .filter(<span class="function"><span class="params">file</span> =&gt;</span> !validFiles.includes(file));</span><br><span class="line">  <span class="keyword">if</span> (conflicts.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 否则依次打印冲突文件</span></span><br><span class="line">  <span class="built_in">console</span>.log(</span><br><span class="line">    <span class="string">`The directory <span class="subst">$&#123;chalk.green(name)&#125;</span> contains files that could conflict:`</span></span><br><span class="line">  );</span><br><span class="line">  <span class="built_in">console</span>.log();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> file <span class="keyword">of</span> conflicts) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`  <span class="subst">$&#123;file&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log();</span><br><span class="line">  <span class="built_in">console</span>.log(</span><br><span class="line">    <span class="string">'Either try using a new directory name, or remove the files listed above.'</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本质上来说，这个函数就是判断创建的这个目录是否包含上述 <code>validFiles</code> 里面的文件</p>
<h3 id="shouldUseYarn"><a href="#shouldUseYarn" class="headerlink" title="shouldUseYarn()"></a>shouldUseYarn()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shouldUseYarn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    execSync(<span class="string">'yarnpkg --version'</span>, &#123; <span class="attr">stdio</span>: <span class="string">'ignore'</span> &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>execSync</code> 是由 <code>node</code> 自身模块 <code>child_process</code> 引用而来，就是用来执行命令的</p>
<p>这几行代码也很好懂，就是判断是否安装了 <code>yarn</code>，如果没有安装 <code>yarn</code>，<code>shouldUseYarn</code> 也会返回 <code>false</code>，不管有没有指定 <code>--use-npm</code></p>
<ul>
<li><code>execSync</code> – 引用至 <code>child_process.execSync</code>，用于执行需要执行的子进程</li>
</ul>
<h3 id="checkThatNpmCanReadCwd"><a href="#checkThatNpmCanReadCwd" class="headerlink" title="checkThatNpmCanReadCwd"></a>checkThatNpmCanReadCwd</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkThatNpmCanReadCwd</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> cwd = process.cwd(); <span class="comment">// 取到当前的进程目录</span></span><br><span class="line">  <span class="keyword">let</span> childOutput = <span class="literal">null</span>; <span class="comment">// 定义一个变量来保存 npm 的信息</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Note: intentionally using spawn over exec since</span></span><br><span class="line">    <span class="comment">// the problem doesn't reproduce otherwise.</span></span><br><span class="line">    <span class="comment">// `npm config list` is the only reliable way I could find</span></span><br><span class="line">    <span class="comment">// to reproduce the wrong path. Just printing process.cwd()</span></span><br><span class="line">    <span class="comment">// in a Node process was not enough.</span></span><br><span class="line">    <span class="comment">// 相当于执行 npm config list，并将返回的信息组合成为一个字符串</span></span><br><span class="line">    childOutput = spawn.sync(<span class="string">'npm'</span>, [<span class="string">'config'</span>, <span class="string">'list'</span>]).output.join(<span class="string">''</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="comment">// Something went wrong spawning node.</span></span><br><span class="line">    <span class="comment">// Not great, but it means we can't do this check.</span></span><br><span class="line">    <span class="comment">// We might fail later on, but let's continue.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断是否是一个字符串</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> childOutput !== <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将整个字符串以换行分隔</span></span><br><span class="line">  <span class="keyword">const</span> lines = childOutput.split(<span class="string">'\n'</span>);</span><br><span class="line">  <span class="comment">// `npm config list` output includes the following line:</span></span><br><span class="line">  <span class="comment">// "; cwd = C:\path\to\current\dir" (unquoted)</span></span><br><span class="line">  <span class="comment">// I couldn't find an easier way to get it.</span></span><br><span class="line">  <span class="comment">// 定义一个我们需要的信息的前缀</span></span><br><span class="line">  <span class="keyword">const</span> prefix = <span class="string">'; cwd = '</span>;</span><br><span class="line">  <span class="comment">// 找整个 lines 里面有没有这个前缀的一行</span></span><br><span class="line">  <span class="keyword">const</span> line = lines.find(<span class="function"><span class="params">line</span> =&gt;</span> line.indexOf(prefix) === <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> line !== <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="comment">// Fail gracefully. They could remove it.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 取出后面的信息，即 npm 执行的目录（可以自己用 npm config list 试一试）</span></span><br><span class="line">  <span class="keyword">const</span> npmCWD = line.substring(prefix.length);</span><br><span class="line">  <span class="comment">// 判断当前目录和执行目录是否一致</span></span><br><span class="line">  <span class="keyword">if</span> (npmCWD === cwd) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 不一致就打印如下信息</span></span><br><span class="line">  <span class="built_in">console</span>.error(</span><br><span class="line">    chalk.red(</span><br><span class="line">      <span class="string">`Could not start an npm process in the right directory.\n\n`</span> +</span><br><span class="line">        <span class="string">`The current directory is: <span class="subst">$&#123;chalk.bold(cwd)&#125;</span>\n`</span> +</span><br><span class="line">        <span class="string">`However, a newly started npm process runs in: <span class="subst">$&#123;chalk.bold(</span></span></span><br><span class="line"><span class="string"><span class="subst">          npmCWD</span></span></span><br><span class="line"><span class="string"><span class="subst">        )&#125;</span>\n\n`</span> +</span><br><span class="line">        <span class="string">`This is probably caused by a misconfigured system terminal shell.`</span></span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 给出了 win32 下通常会奏效的修复命令</span></span><br><span class="line">  <span class="keyword">if</span> (process.platform === <span class="string">'win32'</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(</span><br><span class="line">      chalk.red(<span class="string">`On Windows, this can usually be fixed by running:\n\n`</span>) +</span><br><span class="line">        <span class="string">`  <span class="subst">$&#123;chalk.cyan(</span></span></span><br><span class="line"><span class="string"><span class="subst">          <span class="string">'reg'</span></span></span></span><br><span class="line"><span class="string"><span class="subst">        )&#125;</span> delete "HKCU\\Software\\Microsoft\\Command Processor" /v AutoRun /f\n`</span> +</span><br><span class="line">        <span class="string">`  <span class="subst">$&#123;chalk.cyan(</span></span></span><br><span class="line"><span class="string"><span class="subst">          <span class="string">'reg'</span></span></span></span><br><span class="line"><span class="string"><span class="subst">        )&#125;</span> delete "HKLM\\Software\\Microsoft\\Command Processor" /v AutoRun /f\n\n`</span> +</span><br><span class="line">        chalk.red(<span class="string">`Try to run the above two lines in the terminal.\n`</span>) +</span><br><span class="line">        chalk.red(</span><br><span class="line">          <span class="string">`To learn more about this problem, read: https://blogs.msdn.microsoft.com/oldnewthing/20071121-00/?p=24433/`</span></span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一部分主要也就用了一个外部依赖，为了解决 <code>Node</code> 命令在各平台下的兼容性问题</p>
<ul>
<li><code>cross-spawn</code>：用来执行 node 进程（封装了跨平台兼容）</li>
</ul>
<h3 id="checkNpmVersion"><a href="#checkNpmVersion" class="headerlink" title="checkNpmVersion()"></a>checkNpmVersion()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkNpmVersion</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> hasMinNpm = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">let</span> npmVersion = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    npmVersion = execSync(<span class="string">'npm --version'</span>)</span><br><span class="line">      .toString()</span><br><span class="line">      .trim();</span><br><span class="line">    hasMinNpm = semver.gte(npmVersion, <span class="string">'3.0.0'</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="comment">// ignore</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    hasMinNpm: hasMinNpm,</span><br><span class="line">    npmVersion: npmVersion,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一部分的代码基本一目了然，它返回的就是一个对象（<code>npm 版本号</code> 和 <code>是否由最小 npm 版本限制</code></p>
<p>分析完了 <code>createApp</code> 的所有函数和依赖，接着我们来分析后续执行的 <code>run</code> 函数</p>
<h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><p><code>run</code> 函数在 <code>createApp</code> 函数所有内容执行完毕后执行，它接收 7 个参数</p>
<ul>
<li><code>root</code>：创建的目录绝对路径</li>
<li><code>appName</code>：创建的目录名称</li>
<li><code>version</code>：<code>react-scripts</code> 的版本</li>
<li><code>verbose</code>：继续传递 <code>verbose</code></li>
<li><code>originalDirectory</code>：原始目录，即 <code>create-react-app</code> 在切换前的目录</li>
<li><code>template</code>：模版，不对外使用</li>
<li><code>useYarn</code>：是否使用 <code>yarn</code></li>
</ul>
<p>接下来看看 <code>run</code> 的源代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root,</span></span></span><br><span class="line"><span class="function"><span class="params">  appName,</span></span></span><br><span class="line"><span class="function"><span class="params">  version,</span></span></span><br><span class="line"><span class="function"><span class="params">  verbose,</span></span></span><br><span class="line"><span class="function"><span class="params">  originalDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">  template,</span></span></span><br><span class="line"><span class="function"><span class="params">  useYarn</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 获取依赖包信息（react-script）</span></span><br><span class="line">  <span class="keyword">const</span> packageToInstall = getInstallPackage(version, originalDirectory);</span><br><span class="line">  <span class="comment">// 定义所有依赖包信息</span></span><br><span class="line">  <span class="keyword">const</span> allDependencies = [<span class="string">'react'</span>, <span class="string">'react-dom'</span>, packageToInstall];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 安装过程开始</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Installing packages. This might take a couple of minutes.'</span>);</span><br><span class="line">  getPackageName(packageToInstall)</span><br><span class="line">    .then(<span class="function"><span class="params">packageName</span> =&gt;</span></span><br><span class="line">      <span class="comment">// 是否离线模式，返回结果和包名</span></span><br><span class="line">      checkIfOnline(useYarn).then(<span class="function"><span class="params">isOnline</span> =&gt;</span> (&#123;</span><br><span class="line">        isOnline: isOnline,</span><br><span class="line">        packageName: packageName,</span><br><span class="line">      &#125;))</span><br><span class="line">    )</span><br><span class="line">    .then(<span class="function"><span class="params">info</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 接收上述的包名以及离线模式判断</span></span><br><span class="line">      <span class="keyword">const</span> isOnline = info.isOnline;</span><br><span class="line">      <span class="keyword">const</span> packageName = info.packageName;</span><br><span class="line">      <span class="built_in">console</span>.log(</span><br><span class="line">        <span class="string">`Installing <span class="subst">$&#123;chalk.cyan(<span class="string">'react'</span>)&#125;</span>, <span class="subst">$&#123;chalk.cyan(</span></span></span><br><span class="line"><span class="string"><span class="subst">          <span class="string">'react-dom'</span></span></span></span><br><span class="line"><span class="string"><span class="subst">        )&#125;</span>, and <span class="subst">$&#123;chalk.cyan(packageName)&#125;</span>...`</span></span><br><span class="line">      );</span><br><span class="line">      <span class="built_in">console</span>.log();</span><br><span class="line">      <span class="comment">// 安装依赖</span></span><br><span class="line">      <span class="keyword">return</span> install(root, useYarn, allDependencies, verbose, isOnline).then(</span><br><span class="line">        () =&gt; packageName</span><br><span class="line">      );</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">packageName</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 检查当前 node 版本是否支持包</span></span><br><span class="line">      checkNodeVersion(packageName);</span><br><span class="line">      setCaretRangeForRuntimeDeps(packageName);</span><br><span class="line">      <span class="comment">// 找 init.js 的绝对路径</span></span><br><span class="line">      <span class="keyword">const</span> scriptsPath = path.resolve(</span><br><span class="line">        process.cwd(),</span><br><span class="line">        <span class="string">'node_modules'</span>,</span><br><span class="line">        packageName,</span><br><span class="line">        <span class="string">'scripts'</span>,</span><br><span class="line">        <span class="string">'init.js'</span></span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// 引入 init.js</span></span><br><span class="line">      <span class="keyword">const</span> init = <span class="built_in">require</span>(scriptsPath);</span><br><span class="line">      <span class="comment">// 调用并执行目录拷贝</span></span><br><span class="line">      init(root, appName, verbose, originalDirectory, template);</span><br><span class="line">      <span class="comment">// react-script 0.9 报警告</span></span><br><span class="line">      <span class="keyword">if</span> (version === <span class="string">'react-scripts@0.9.x'</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">          chalk.yellow(</span><br><span class="line">            <span class="string">`\nNote: the project was boostrapped with an old unsupported version of tools.\n`</span> +</span><br><span class="line">              <span class="string">`Please update to Node &gt;=6 and npm &gt;=3 to get supported tools in new projects.\n`</span></span><br><span class="line">          )</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 异常处理</span></span><br><span class="line">    .catch(<span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log();</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Aborting installation.'</span>);</span><br><span class="line">      <span class="comment">// 有具体信息则报具体信息</span></span><br><span class="line">      <span class="keyword">if</span> (reason.command) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`  <span class="subst">$&#123;chalk.cyan(reason.command)&#125;</span> has failed.`</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 没有就要求回报 bug</span></span><br><span class="line">        <span class="built_in">console</span>.log(chalk.red(<span class="string">'Unexpected error. Please report it as a bug:'</span>));</span><br><span class="line">        <span class="built_in">console</span>.log(reason);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">console</span>.log();</span><br><span class="line">      <span class="comment">// 出现异常时删除这些文件</span></span><br><span class="line">      <span class="comment">// On 'exit' we will delete these files from target directory.</span></span><br><span class="line">      <span class="keyword">const</span> knownGeneratedFiles = [</span><br><span class="line">        <span class="string">'package.json'</span>,</span><br><span class="line">        <span class="string">'npm-debug.log'</span>,</span><br><span class="line">        <span class="string">'yarn-error.log'</span>,</span><br><span class="line">        <span class="string">'yarn-debug.log'</span>,</span><br><span class="line">        <span class="string">'node_modules'</span>,</span><br><span class="line">      ];</span><br><span class="line">      <span class="keyword">const</span> currentFiles = fs.readdirSync(path.join(root));</span><br><span class="line">      <span class="comment">// 挨个删除</span></span><br><span class="line">      currentFiles.forEach(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">        knownGeneratedFiles.forEach(<span class="function"><span class="params">fileToMatch</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// This will catch `(npm-debug|yarn-error|yarn-debug).log*` files</span></span><br><span class="line">          <span class="comment">// and the rest of knownGeneratedFiles.</span></span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            (fileToMatch.match(<span class="regexp">/.log/g</span>) &amp;&amp; file.indexOf(fileToMatch) === <span class="number">0</span>) ||</span><br><span class="line">            file === fileToMatch</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`Deleting generated file... <span class="subst">$&#123;chalk.cyan(file)&#125;</span>`</span>);</span><br><span class="line">            fs.removeSync(path.join(root, file));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// 当前目录下是否还存在文件</span></span><br><span class="line">      <span class="keyword">const</span> remainingFiles = fs.readdirSync(path.join(root));</span><br><span class="line">      <span class="keyword">if</span> (!remainingFiles.length) &#123;</span><br><span class="line">        <span class="comment">// Delete target folder if empty</span></span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">          <span class="string">`Deleting <span class="subst">$&#123;chalk.cyan(<span class="string">`<span class="subst">$&#123;appName&#125;</span> /`</span>)&#125;</span> from <span class="subst">$&#123;chalk.cyan(</span></span></span><br><span class="line"><span class="string"><span class="subst">            path.resolve(root, <span class="string">'..'</span>)</span></span></span><br><span class="line"><span class="string"><span class="subst">          )&#125;</span>`</span></span><br><span class="line">        );</span><br><span class="line">        process.chdir(path.resolve(root, <span class="string">'..'</span>));</span><br><span class="line">        fs.removeSync(path.join(root));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Done.'</span>);</span><br><span class="line">      process.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>run</code> 这个函数中大量使用了 <code>Promise</code> 回调，这一部分的知识在之前的文章中也提到过。下面我们来拆解其中的每一句和每一个函数的作用</p>
<p>外部依赖都是和之前一样的，我们来看看内部调用了哪些函数</p>
<ul>
<li><code>getInstallPackage</code> – 获取要安装的 <code>react-script</code> 版本或者开发者自己定义的 <code>react-scripts</code></li>
<li><code>getPackageName</code> – 获取正式安装的 <code>react-scripts</code> 包名</li>
<li><code>checkIfOnline</code> – 检查网络连接是否正常</li>
<li><code>install</code> – 安装依赖包</li>
<li><code>checkNodeVersion</code> – 检查 <code>Node</code> 版本信息</li>
<li><code>setCaretRangeForRuntimeDeps</code> – 检查开发依赖是否正确安装，版本是否正确</li>
<li><code>init</code> – 将事先定义好的目录文件拷贝到我的项目中</li>
</ul>
<h3 id="getInstallPackage"><a href="#getInstallPackage" class="headerlink" title="getInstallPackage"></a>getInstallPackage</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getInstallPackage</span>(<span class="params">version, originalDirectory</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> packageToInstall = <span class="string">'react-scripts'</span>; <span class="comment">// 默认 react-script 标准包名</span></span><br><span class="line">  <span class="keyword">const</span> validSemver = semver.valid(version); <span class="comment">// 校验版本号是否合法</span></span><br><span class="line">  <span class="keyword">if</span> (validSemver) &#123;</span><br><span class="line">    packageToInstall += <span class="string">`@<span class="subst">$&#123;validSemver&#125;</span>`</span>; <span class="comment">// 合法的话，就安装指定版本，在 npm install 安装的时候加上 ` @x.x.x` 版本号，安装指定版本的 react-scripts</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version &amp;&amp; version.match(<span class="regexp">/^file:/</span>)) &#123;</span><br><span class="line">    <span class="comment">// 不合法且版本号带有 file:，执行以下代码，作用时安装我们自定义的包</span></span><br><span class="line">    packageToInstall = <span class="string">`file:<span class="subst">$&#123;path.resolve(</span></span></span><br><span class="line"><span class="string"><span class="subst">      originalDirectory,</span></span></span><br><span class="line"><span class="string"><span class="subst">      version.match(<span class="regexp">/^file:(.*)?$/</span>)[<span class="number">1</span>]</span></span></span><br><span class="line"><span class="string"><span class="subst">    )&#125;</span>`</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version) &#123;</span><br><span class="line">    <span class="comment">// 以上条件都不满足就安装默认的文件</span></span><br><span class="line">    <span class="comment">// for tar.gz or alternative paths</span></span><br><span class="line">    packageToInstall = version;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回最终需要安装的 react-scripts 的信息</span></span><br><span class="line">  <span class="keyword">return</span> packageToInstall;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个函数接收两个参数，<code>version</code> 和 <code>originalDictionary</code>，主要的作用根据参数是生成 <code>react-script</code> 的安装版本。一开始初始化的项目是可以指定 <code>react-script</code> 版本，甚至自定义这个包的，所以有了这几种校验机制</p>
<h3 id="getPackageName"><a href="#getPackageName" class="headerlink" title="getPackageName"></a>getPackageName</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Extract package name from tarball url or path.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPackageName</span>(<span class="params">installPackage</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 根据上面传回的安装版本来安装这个包，返回正规的包名</span></span><br><span class="line">  <span class="keyword">if</span> (installPackage.match(<span class="regexp">/^.+\.(tgz|tar\.gz)$/</span>)) &#123;</span><br><span class="line">    <span class="comment">// 创建了一个临时目录</span></span><br><span class="line">    <span class="keyword">return</span> getTemporaryDirectory()</span><br><span class="line">      .then(<span class="function"><span class="params">obj</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> stream;</span><br><span class="line">        <span class="comment">// 线上安装情况</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/^http/</span>.test(installPackage)) &#123;</span><br><span class="line">          stream = hyperquest(installPackage);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 本地读取情况</span></span><br><span class="line">          stream = fs.createReadStream(installPackage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 通过 Node 的流处理返回</span></span><br><span class="line">        <span class="keyword">return</span> extractStream(stream, obj.tmpdir).then(<span class="function"><span class="params">()</span> =&gt;</span> obj);</span><br><span class="line">      &#125;)</span><br><span class="line">      .then(<span class="function"><span class="params">obj</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 这段没太看懂……</span></span><br><span class="line">        <span class="keyword">const</span> packageName = <span class="built_in">require</span>(path.join(obj.tmpdir, <span class="string">'package.json'</span>)).name;</span><br><span class="line">        obj.cleanup();</span><br><span class="line">        <span class="keyword">return</span> packageName;</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// The package name could be with or without semver version, e.g. react-scripts-0.2.0-alpha.1.tgz</span></span><br><span class="line">        <span class="comment">// However, this function returns package name only without semver version.</span></span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">          <span class="string">`Could not extract the package name from the archive: <span class="subst">$&#123;err.message&#125;</span>`</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">const</span> assumedProjectName = installPackage.match(</span><br><span class="line">          /^.+\/(.+?)(?:-\d+.+)?\.(tgz|tar\.gz)$/</span><br><span class="line">        )[<span class="number">1</span>];</span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">          <span class="string">`Based on the filename, assuming it is "<span class="subst">$&#123;chalk.cyan(</span></span></span><br><span class="line"><span class="string"><span class="subst">            assumedProjectName</span></span></span><br><span class="line"><span class="string"><span class="subst">          )&#125;</span>"`</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(assumedProjectName);</span><br><span class="line">      &#125;);</span><br><span class="line">  <span class="comment">// 信息中包含 git+ 的情况</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installPackage.indexOf(<span class="string">'git+'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Pull package name out of git urls e.g:</span></span><br><span class="line">    <span class="comment">// git+https://github.com/mycompany/react-scripts.git</span></span><br><span class="line">    <span class="comment">// git+ssh://github.com/mycompany/react-scripts.git#v1.2.3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(installPackage.match(<span class="regexp">/([^/]+)\.git(#.*)?$/</span>)[<span class="number">1</span>]);</span><br><span class="line">  <span class="comment">// 只包含版本信息时的情况</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installPackage.match(<span class="regexp">/.+@/</span>)) &#123;</span><br><span class="line">    <span class="comment">// Do not match @scope/ when stripping off @version or @tag</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(</span><br><span class="line">      installPackage.charAt(<span class="number">0</span>) + installPackage.substr(<span class="number">1</span>).split(<span class="string">'@'</span>)[<span class="number">0</span>]</span><br><span class="line">    );</span><br><span class="line">  <span class="comment">// 包含 file: 开头的情况    </span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installPackage.match(<span class="regexp">/^file:/</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> installPackagePath = installPackage.match(<span class="regexp">/^file:(.*)?$/</span>)[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">const</span> installPackageJson = <span class="built_in">require</span>(path.join(installPackagePath, <span class="string">'package.json'</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(installPackageJson.name);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 什么都没有直接返回包名</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(installPackage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个函数的目标就是返回一个正常的依赖包名，比如我们什么都不带就返回 <code>react-scripts</code>，是我们自定义的包就返回 <code>my-react-scripts</code>，接下来就采用 <code>Promise</code> 回调的方式一直执行到最后</p>
<p>先来看它的外部依赖：</p>
<ul>
<li><code>hyperquest</code>：用于生成流式 <code>http</code> 请求</li>
</ul>
<p>它还调用了两个函数依赖，这两个函数比较简单，所以不做详细解读：</p>
<ul>
<li><code>getTemporaryDirectory</code>：本身是一个回调函数，用来创建一个临时目录</li>
<li><code>extractStream</code>：利用流式传输下载数据，<code>Stream</code> 本身是为了减少内存开销，优化用户体验</li>
</ul>
<h3 id="checkIfOnline"><a href="#checkIfOnline" class="headerlink" title="checkIfOnline"></a>checkIfOnline</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkIfOnline</span>(<span class="params">useYarn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!useYarn) &#123;</span><br><span class="line">    <span class="comment">// Don't ping the Yarn registry.</span></span><br><span class="line">    <span class="comment">// We'll just assume the best case.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    dns.lookup(<span class="string">'registry.yarnpkg.com'</span>, err =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> proxy;</span><br><span class="line">      <span class="comment">// 自定代理</span></span><br><span class="line">      <span class="keyword">if</span> (err != <span class="literal">null</span> &amp;&amp; (proxy = getProxy())) &#123;</span><br><span class="line">        <span class="comment">// If a proxy is defined, we likely can't resolve external hostnames.</span></span><br><span class="line">        <span class="comment">// Try to resolve the proxy name as an indication of a connection.</span></span><br><span class="line">        dns.lookup(url.parse(proxy).hostname, proxyErr =&gt; &#123;</span><br><span class="line">          resolve(proxyErr == <span class="literal">null</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">      <span class="comment">// 否则直接返回空错误信息</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(err == <span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数本身接收一个是否使用 <code>yarn</code> 的参数来判断是否进行后续，如果使用的是 <code>npm</code> 直接返回 true，这个函数本身是为了调用 <code>yarn</code> 本身的离线安装功能</p>
<p>外部依赖：</p>
<ul>
<li><code>dns</code>：用来检测是否能够请求到指定的地址</li>
</ul>
<h3 id="install"><a href="#install" class="headerlink" title="install()"></a>install()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">install</span>(<span class="params">root, useYarn, dependencies, verbose, isOnline</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> command; <span class="comment">// 定义命令</span></span><br><span class="line">    <span class="keyword">let</span> args; <span class="comment">// 定义命令参数</span></span><br><span class="line">    <span class="comment">// 如果使用 yarn</span></span><br><span class="line">    <span class="keyword">if</span> (useYarn) &#123;</span><br><span class="line">      command = <span class="string">'yarnpkg'</span>; <span class="comment">// 命令名称</span></span><br><span class="line">      args = [<span class="string">'add'</span>, <span class="string">'--exact'</span>]; <span class="comment">// 基础命令参数</span></span><br><span class="line">      <span class="keyword">if</span> (!isOnline) &#123;</span><br><span class="line">        args.push(<span class="string">'--offline'</span>); <span class="comment">// 在命令参数上接一个函数，判断是否加入离线模式</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 组合参数 + 开发依赖 ‘react’ ’react-dom‘ ’react-scripts‘</span></span><br><span class="line">      [].push.apply(args, dependencies);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Explicitly set cwd() to work around issues like</span></span><br><span class="line">      <span class="comment">// https://github.com/facebookincubator/create-react-app/issues/3326.</span></span><br><span class="line">      <span class="comment">// Unfortunately we can only do this for Yarn because npm support for</span></span><br><span class="line">      <span class="comment">// equivalent --prefix flag doesn't help with this issue.</span></span><br><span class="line">      <span class="comment">// This is why for npm, we run checkThatNpmCanReadCwd() early instead.</span></span><br><span class="line">      args.push(<span class="string">'--cwd'</span>); <span class="comment">// 指定命令执行目录的地址</span></span><br><span class="line">      args.push(root); <span class="comment">// 执行目录绝对路径</span></span><br><span class="line">      <span class="comment">// 离线模式会给出警告，提示正在调用 yarn 本地缓存安装</span></span><br><span class="line">      <span class="keyword">if</span> (!isOnline) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(chalk.yellow(<span class="string">'You appear to be offline.'</span>));</span><br><span class="line">        <span class="built_in">console</span>.log(chalk.yellow(<span class="string">'Falling back to the local Yarn cache.'</span>));</span><br><span class="line">        <span class="built_in">console</span>.log();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 否则就拼一套 npm 的命令</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      command = <span class="string">'npm'</span>;</span><br><span class="line">      args = [</span><br><span class="line">        <span class="string">'install'</span>,</span><br><span class="line">        <span class="string">'--save'</span>,</span><br><span class="line">        <span class="string">'--save-exact'</span>,</span><br><span class="line">        <span class="string">'--loglevel'</span>,</span><br><span class="line">        <span class="string">'error'</span>,</span><br><span class="line">      ].concat(dependencies);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 因为 yarn 和 npm 都可以带这个参数，所以单独拿了出来</span></span><br><span class="line">    <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">      args.push(<span class="string">'--verbose'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 组合命令并执行</span></span><br><span class="line">    <span class="keyword">const</span> child = spawn(command, args, &#123; <span class="attr">stdio</span>: <span class="string">'inherit'</span> &#125;);</span><br><span class="line">    <span class="comment">// 执行完毕后关闭</span></span><br><span class="line">    child.on(<span class="string">'close'</span>, code =&gt; &#123;</span><br><span class="line">      <span class="comment">// 不为 0 即非正常关闭，</span></span><br><span class="line">      <span class="keyword">if</span> (code !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 抛出错误</span></span><br><span class="line">        reject(&#123;</span><br><span class="line">          command: <span class="string">`<span class="subst">$&#123;command&#125;</span> <span class="subst">$&#123;args.join(<span class="string">' '</span>)&#125;</span>`</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 正常则继续往下执行</span></span><br><span class="line">      resolve();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的作用就是组合一个 <code>yarn</code> 或者 <code>npm</code> 的安装命令，把这些模块装到项目的文件夹中</p>
<p>执行到这个流程，<code>create-react-app</code> 已经帮我们创建好了项目，<code>package.json</code> 安装了所有的依赖，<code>react</code>、<code>react-dom</code>、<code>react-scripts</code></p>
<h3 id="checkNodeVersion"><a href="#checkNodeVersion" class="headerlink" title="checkNodeVersion()"></a>checkNodeVersion()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkNodeVersion</span>(<span class="params">packageName</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 找 react-scripts 的 package.json 路径</span></span><br><span class="line">  <span class="keyword">const</span> packageJsonPath = path.resolve(</span><br><span class="line">    process.cwd(),</span><br><span class="line">    <span class="string">'node_modules'</span>,</span><br><span class="line">    packageName,</span><br><span class="line">    <span class="string">'package.json'</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 在 package.json 中定义了一个 engines 其中放着 Node 版本的信息</span></span><br><span class="line">  <span class="keyword">const</span> packageJson = <span class="built_in">require</span>(packageJsonPath);</span><br><span class="line">  <span class="comment">// 在 package.json 中定义了一个 engines，其中放着 Node 版本的信息</span></span><br><span class="line">  <span class="keyword">if</span> (!packageJson.engines || !packageJson.engines.node) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 比较进程的 Node 版本信息，是否小于最小支持的版本</span></span><br><span class="line">  <span class="keyword">if</span> (!semver.satisfies(process.version, packageJson.engines.node)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(</span><br><span class="line">      chalk.red(</span><br><span class="line">        <span class="string">'You are running Node %s.\n'</span> +</span><br><span class="line">          <span class="string">'Create React App requires Node %s or higher. \n'</span> +</span><br><span class="line">          <span class="string">'Please update your version of Node.'</span></span><br><span class="line">      ),</span><br><span class="line">      process.version,</span><br><span class="line">      packageJson.engines.node</span><br><span class="line">    );</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就是检查 <code>Node</code> 版本，<code>react-scripts</code> 需要依赖 <code>Node</code> 版本，也就是说低版本的 <code>Node</code> 不支持</p>
<h3 id="setCaretRangeForRuntimeDeps"><a href="#setCaretRangeForRuntimeDeps" class="headerlink" title="setCaretRangeForRuntimeDeps"></a>setCaretRangeForRuntimeDeps</h3><h2 id="babel-preset-react-app"><a href="#babel-preset-react-app" class="headerlink" title="babel-preset-react-app"></a>babel-preset-react-app</h2><p>查询它的 <code>package.json</code> 可以发现，<code>babel-preset-react-app</code> 这个子模块是为了在输入指令不同时向整个项目加入不同的 <code>webpack</code> 配置</p>

      
    </div>

    

    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Helvetica.D</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://www.douglasdong.site/2018-10-13.html" title="create-react-app 源代码分析">https://www.douglasdong.site/2018-10-13.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
          
            <a href="/tags/React/" rel="tag"># React</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018-10-08.html" rel="next" title="AntD/Choerodon-UI 源码分析（7）- Breadcrumb 组件">
                <i class="fa fa-chevron-left"></i> AntD/Choerodon-UI 源码分析（7）- Breadcrumb 组件
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018-12-17.html" rel="prev" title="React 重复渲染分析及优化">
                React 重复渲染分析及优化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div onclick="showGitment()" id="gitment-display-button">显示 Gitment 评论</div>
        <div id="gitment-container" style="display:none"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.PNG"
                alt="Helvetica.D" />
            
              <p class="site-author-name" itemprop="name">Helvetica.D</p>
              <p class="site-description motion-element" itemprop="description">P5天下第一！！</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">28</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/Xeonice" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:ad546971975@gmail.com" target="_blank" title="E-Mail" rel="external nofollow"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#package-json"><span class="nav-number">1.</span> <span class="nav-text">package.json</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#devDependencies"><span class="nav-number">1.1.</span> <span class="nav-text">devDependencies</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#packages"><span class="nav-number">2.</span> <span class="nav-text">packages</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#create-react-app"><span class="nav-number">2.1.</span> <span class="nav-text">create-react-app</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#index-js"><span class="nav-number">2.1.1.</span> <span class="nav-text">index.js</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#create-react-app-1"><span class="nav-number">2.2.</span> <span class="nav-text">create-react-app</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#checkAppName"><span class="nav-number">2.2.1.</span> <span class="nav-text">checkAppName()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#isSafeToCreateProjectIn"><span class="nav-number">2.2.2.</span> <span class="nav-text">isSafeToCreateProjectIn</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shouldUseYarn"><span class="nav-number">2.2.3.</span> <span class="nav-text">shouldUseYarn()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#checkThatNpmCanReadCwd"><span class="nav-number">2.2.4.</span> <span class="nav-text">checkThatNpmCanReadCwd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#checkNpmVersion"><span class="nav-number">2.2.5.</span> <span class="nav-text">checkNpmVersion()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#run"><span class="nav-number">2.2.6.</span> <span class="nav-text">run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getInstallPackage"><span class="nav-number">2.2.7.</span> <span class="nav-text">getInstallPackage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getPackageName"><span class="nav-number">2.2.8.</span> <span class="nav-text">getPackageName</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#checkIfOnline"><span class="nav-number">2.2.9.</span> <span class="nav-text">checkIfOnline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#install"><span class="nav-number">2.2.10.</span> <span class="nav-text">install()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#checkNodeVersion"><span class="nav-number">2.2.11.</span> <span class="nav-text">checkNodeVersion()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#setCaretRangeForRuntimeDeps"><span class="nav-number">2.2.12.</span> <span class="nav-text">setCaretRangeForRuntimeDeps</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#babel-preset-react-app"><span class="nav-number">2.3.</span> <span class="nav-text">babel-preset-react-app</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Helvetica.D</span>
  <div class="powered-by">  </div>
  <span>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">228k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">3:27</span>
  
</div>


  



  <div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" rel="external nofollow" href="https://theme-next.org">NexT.Muse</a> v6.4.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>







  






  













  



  
  
    <script type="text/javascript" src="https://cdn.staticfile.org/jquery/2.1.3/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.staticfile.org/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.staticfile.org/velocity/1.2.1/velocity.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.staticfile.org/velocity/1.2.1/velocity.ui.min.js"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.staticfile.org/fancybox/3.3.5/jquery.fancybox.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/reading_progress/reading_progress.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  






<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname,
            owner: 'Xeonice',
            repo: 'DouglasDongComment',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '2ffef8417a91b7f5915345b2c029d170112c0429',
            
                client_id: 'b15c18bda9a832e21a62'
            }});
        gitment.render('gitment-container');
      }

      
      function showGitment(){
        document.getElementById("gitment-display-button").style.display = "none";
        document.getElementById("gitment-container").style.display = "block";
        renderGitment();
      }
      
      </script>
    






  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  
  
  
  <script src="/lib/bookmark/bookmark.min.js?v=1.0"></script>
  <script type="text/javascript">
  
    bookmark.scrollToMark('auto', "#更多");
  
  </script>


  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('复制成功')
          else $(this).text('复制失败')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


</body>
</html>
